name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e
          
          # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /var/www/bitcoin-center-seoul
          
          # Git ìƒíƒœ í™•ì¸
          echo "í˜„ì¬ ë¸Œëœì¹˜: $(git branch --show-current)"
          echo "ìµœì‹  ì»¤ë°‹: $(git log -1 --oneline)"
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ stash
          if [ -n "$(git status --porcelain)" ]; then
            echo "ë¡œì»¬ ë³€ê²½ì‚¬í•­ì„ stashí•©ë‹ˆë‹¤..."
            git stash push -m "Deploy stash $(date)"
          fi
          
          # GitHubì—ì„œ ìµœì‹  ì½”ë“œ pull
          echo "GitHubì—ì„œ ìµœì‹  ì½”ë“œë¥¼ pullí•©ë‹ˆë‹¤..."
          git fetch origin
          git reset --hard origin/main
          
          # ìµœì‹  ì»¤ë°‹ ì •ë³´ ì¶œë ¥
          echo "ì—…ë°ì´íŠ¸ëœ ì»¤ë°‹: $(git log -1 --oneline)"
          
          # ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          npm install
          
          # í”„ë¡œë•ì…˜ ë¹Œë“œ
          echo "ğŸ”¨ í”„ë¡œë•ì…˜ ë¹Œë“œ ì¤‘..."
          npm run build
          
          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          if [ ! -d "dist" ]; then
            echo "âŒ ë¹Œë“œ ì‹¤íŒ¨: dist ë””ë ‰í† ë¦¬ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "âœ… ë¹Œë“œ ì™„ë£Œ: $(du -sh dist | cut -f1) í¬ê¸°ì˜ dist ë””ë ‰í† ë¦¬ ìƒì„±"
          
          # PM2ë¡œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          echo "ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
          pm2 restart bitcoin-center-seoul || pm2 start ecosystem.config.js
          
          # PM2 ìƒíƒœ í™•ì¸
          echo "ğŸ“Š PM2 ì„œë¹„ìŠ¤ ìƒíƒœ:"
          pm2 status
          
          # PM2 ì„¤ì • ì €ì¥
          pm2 save
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          
    - name: Health Check
      run: |
        sleep 10
        curl -f http://${{ secrets.EC2_HOST }} || exit 1
